/*! Money 2014-06-02 */
angular.module("barsOfGold",["ui.bootstrap","ngRoute"]).config(["$routeProvider",function(a){a.when("/accounts",{templateUrl:"/app/src/templates/account-list.html"}).when("/account/:accountId",{templateUrl:"/app/src/templates/account.html"}).when("/transaction/:transactionId",{templateUrl:"/app/src/templates/transaction2.html"}).otherwise({redirectTo:"/accounts"})}]),angular.module("barsOfGold").controller("AccountController",["$scope","$rootScope","$modal","$log","$routeParams","$location",function(a,b,c,d,e,f){a.format="yyyy-MM-dd";for(var g=!1,h=0;h<a.accounts.length;h++)a.accounts[h]._id==e.accountId&&(a.account=a.accounts[h],g=!0);g||f.url("/accounts"),a.transaction={},a.transaction.transType="Expense",a.dateOptions={formatYear:"yy",startingDay:1},a.open=function(b){b.preventDefault(),b.stopPropagation(),a.opened=!0},a.transaction.date=moment().add("days",-1).format("YYYY-MM-DD"),a.today=function(){a.transaction.date=moment().format("YYYY-MM-DD")},a.isYesterday=function(){return moment().add("days",-1).isSame(a.transaction.date,"day")},a.isToday=function(){return moment().isSame(a.transaction.date,"day")},a.yesterday=function(){a.transaction.date=moment().add("days",-1).format("YYYY-MM-DD")},a.backToList=function(){f.url("/accounts")},a.remaining=function(){if(a.account){var b=a.account;return"credit"==b._type?-1*(b.max-b.balance):b.balance}return 0}}]),angular.module("barsOfGold").controller("AccountListController",["$scope","$rootScope","$modal","$log",function(a){a.remaining=function(a){return"credit"==a._type?-1*(a.max-a.balance):a.balance}}]),angular.module("barsOfGold").controller("EditTransactionController",["$scope","$modal","$log","ModalInstanceCtrl",function(a,b,c,d){a.open=function(e){var f=b.open({templateUrl:"transaction_content.html",controller:d,size:e,resolve:{items:function(){return a.items}}});f.result.then(function(b){a.selected=b},function(){c.info("Modal dismissed at: "+new Date)})}}]),angular.module("barsOfGold").controller("GraphCtrl",["$scope",function(){console.log("moneyApp,GraphCtrl")}]),angular.module("barsOfGold").controller("MainController",["$scope","$rootScope","$location",function(a,b,c){a.name="Hello world",b.socket=io.connect(),a.accounts=[],a.socket.on("accounts",function(b){a.accounts=b,console.log("accounts",b),a.$apply()}),a.socket.emit("requestAccounts",{}),a.socket.on("accountUpdated",function(b){console.log("accountUpdated",b);for(var c=0;c<a.accounts.length;c++)if(a.accounts[c]._id==b._id){a.accounts[c].balance=b.balance,a.accounts[c].confirmed=b.confirmed,a.$apply();break}}),a.viewAccount=function(b){console.log("requestTransactions",b.name),c.url("/account/"+b._id),a.socket.emit("requestTransactions",{id:b._id,name:b.name})},a.socket.emit("requestTransactions",{}),a.socket.emit("requestCandleData",{}),a.socket.on("candleDataServed",function(b){console.log("candleDataServed",b),a.candlechart=b,a.$apply()}),a.candlechart=null,a.barchart=[]}]),angular.module("barsOfGold").controller("TransactionListController",["$scope",function(a){a.transactions=[],a.socket.on("transactions",function(b){a.transactions=b.transactions,a.headerTitle=b.title,a.$apply()})}]).controller("TransactionController",["$scope",function(a){a.init=function(b){a.transaction=b},a.$watch("transaction.confirmed",function(b,c){if(b!=c){var d=a.transaction,e={id:d._id,newValue:d.confirmed,accountId:d.account};console.log("toggleConfirm",d,e,b,c),a.socket.emit("toggleConfirmTransaction",e)}})}]),window.accounts=[{_id:{$oid:"508ad4ebe4b0d0aee183c83d"},_type:"checking",balance:1440.4399999999987,confirmed:1440.4399999999987,link:"http://www.chase.com",name:"Chase",priority:2},{__v:0,_id:{$oid:"509001538389539539000001"},_type:"credit",balance:-4157.089999999998,confirmed:-4179.819999999997,link:"http://eservice.bananarepublic.com",max:-4300,name:"Banana",priority:1},{__v:0,_id:{$oid:"5097f78d58ca8b5278000001"},_type:"credit",balance:-7646.6299999999965,confirmed:-7646.6299999999965,link:"http://www.chase.com",max:-8e3,name:"Slate",priority:1},{__v:0,_id:{$oid:"50a50f4259b7930200000009"},_type:"credit",balance:-3280.4899999999984,confirmed:-3280.4899999999984,link:"http://www.bestbuy.accountonline.com",max:-3400,name:"Best Buy",priority:1},{__v:0,_id:{$oid:"50b64e145af0090200000002"},_type:"credit",balance:-12815.95,confirmed:-12954.550000000001,link:"www.juniper.com",max:-13400,name:"Frontier Cc",priority:1},{__v:0,_id:{$oid:"50f88c2550de020200000002"},_type:"checking",balance:713.5100000000009,confirmed:1033.120000000001,link:"http://www.simple.com",name:"Simple",priority:3},{__v:0,_id:{$oid:"5122878da50ff7020000000d"},_type:"retirement",balance:37721.64,confirmed:37721.64,link:"http://www.ohionational.com",name:"401k - Ohio National",priority:0}],angular.module("barsOfGold").directive("epochCandle",["$parse",function(a){return{restrict:"E",replace:!0,transclude:!1,compile:function(b,c){var d=a(c.ngModel),e='<div id="'+c.id+'" class="epoch category20b col-lg-6" style="'+(c.id||"height:120px;width:780px;")+'"></div>',f=$(e);return b.replaceWith(f),function(a,b){console.log("epoch on",b);a.$watch(d,function(a){a&&b.MonthProgress(a,!1,120,12)})}}}}]).directive("epochBar",["$parse",function(a){return{restrict:"E",replace:!0,transclude:!1,compile:function(b,c){var d=a(c.ngModel),e='<div id="+ attrs.id +" class="epoch category20b col-lg-6" style="height:120px;width:600px;"></div>',f=$(e);return b.replaceWith(f),function(a,b){var c;a.$watch(d,function(a){console.log("model",a,c),c?c.update(a):c=b.epoch({type:"line",data:a})})}}}}]),function(a){"use strict";function b(a,b){for(var c=[],d=0,e=d3.max(a,function(a){return a.date}),f=d3.min(a,function(a){return a.date}),g=moment(f),h=function(a){var b=a.date.diff(g);0===b&&(d+=-1*a.value)};e>=g;){var i={};i.date=moment(g),i.label=i.date.format("MMM-YY"),i.startBalance=d,a.forEach(h),i.endBalance=d,c.push(i),g.add("months",1)}return c.splice(0,1),console.log(c.length,b),b&&b>0&&c.length>b&&c.splice(0,c.length-b),c}function c(a,b){return a(b.startBalance)<a(b.endBalance)?a(b.startBalance):a(b.endBalance)}function d(a,b){return a(b.endBalance)>a(b.startBalance)?a(b.endBalance)-a(b.startBalance):a(b.startBalance)-a(b.endBalance)}function e(a){var b=a.startBalance-a.endBalance,c=0;0!==a.startBalance&&(c=b/a.startBalance);var d=parseFloat(a.endBalance).toFixed(2),e="{0}, {1} to {2}, {3} ${4} {5} %".format(a.label,a.startBalance.toFixed(2),d,b>0?"up":"down",b.toFixed(2),(100*c).toFixed(2));return e}String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,c){return"undefined"!=typeof a[c]?a[c]:b})},a.fn.MonthProgress=function(f,g,h,i){var j,k,l,m,n,o,p,q,r,s,t,u=65,v=10,w=10,x=5;if(g&&(x=60),!d3)throw"d3 is required for this plugin";f.forEach(function(a){a.date=moment(a._id)}),console.log("rollingMonths",f,g,h,i),m=b(f,i),n=d3.max(m,function(a){return a.startBalance>a.endBalance?a.startBalance:a.endBalance}),o=d3.min(m,function(a){return a.startBalance<a.endBalance?a.startBalance:a.endBalance});var y=a(this).get(0),z=a(y).parent().width();j=d3.select(y).append("svg:svg").attr("width",z).attr("height",h).classed("graph",!0),r=a(j[0]).width()-(u+v),t=a(j[0]).height()-(x+w),k=d3.scale.linear().domain([0,m.length]).range([u,r+u]),l=d3.scale.linear().domain([o,n]).range([w,t+w]),s=Math.ceil(r/m.length);var A=[];A.push("#BD33A4"),A.push("#AA98A9"),A.push("#CC0000"),A.push("#65000B"),A.push("#A40000"),A.push("#E30022"),A.push("#A32638"),A.push("#9B111E"),A.push("#66424D"),A.push("#800020"),A.push("#CE2029"),A.push("#CC3333"),A.push("#C80815"),A.push("#50404D"),A.push("#808080");var B=Math.floor(A.length*Math.random());console.log("redIndex",B,A[B]);var C=function(){return A[1]},D=[];D.push("#007AA5"),D.push("#4682B4"),D.push("#666699"),D.push("#50404D"),D.push("#708090");var E=Math.floor(D.length*Math.random());console.log("blueIndex",E,D[E]);var F=function(){return D[E]};j.selectAll("rect").data(m).enter().append("svg:rect").attr("x",function(a,b){return k(b)}).attr("y",function(a,b){return c(l,a,b)}).attr("height",function(a,b){return d(l,a,b)}).attr("width",s).attr("title",function(a){return e(a)}).attr("data-toggle","tooltip").attr("data-trigger","hover focus click").attr("fill",function(a,b){return a.startBalance>a.endBalance?F():C(b)}),p=d3.svg.axis().scale(k).ticks(m.length).tickSize(-t),j.append("svg:g").attr("class","x axis").attr("transform","translate(0,"+(t+w)+")").call(p),g?j.selectAll(".x text").attr("style","writing-mode: tb").attr("transform","translate("+s/2+",-10)").attr("title",function(a,b){return m.length>b?e(m[b]):""}).attr("data-toggle","tooltip").attr("data-trigger","hover focus click").text(function(a,b){return m.length>b?m[b].label:""}):j.selectAll(".x text").text(""),q=d3.svg.axis().scale(l).ticks(7).orient("left"),j.append("g").attr("class","y axis").attr("transform","translate( "+k(0)+",0)").call(q),a("rect").tooltip({container:"body",placement:"auto top"}),a(".x text").tooltip({container:"body"})}}(jQuery);